#!/usr/bin/env python3\n\"\"\"\nBrother QL-700 Label Printer - Command Line Interface\nPrint labels with QR codes from CSV files\n\"\"\"\n\nimport csv\nimport argparse\nimport sys\nimport os\nfrom pathlib import Path\n\n# Add parent directory to path to import print_utils\nsys.path.append(str(Path(__file__).parent.parent / 'webapp'))\n\ntry:\n    import print_utils\nexcept ImportError:\n    print(\"Error: Could not import print_utils. Make sure you're running from the correct directory.\")\n    sys.exit(1)\n\n\ndef print_single_label(printer_id, product_name, label_type='62', include_qr=True):\n    \"\"\"Print a single label\"\"\"\n    try:\n        print_utils.print_label_safe(\n            printer_id=printer_id,\n            label_text=product_name,\n            label_type=label_type,\n            include_qr=include_qr\n        )\n        return True\n    except Exception as e:\n        print(f\"Error printing '{product_name}': {e}\")\n        return False\n\n\ndef print_from_csv(csv_file, printer_id=None, label_type='62', include_qr=True, \n                  start=1, end=None, test_mode=False):\n    \"\"\"Print labels from CSV file\"\"\"\n    try:\n        with open(csv_file, 'r', encoding='utf-8') as f:\n            reader = csv.DictReader(f)\n            products = list(reader)\n        \n        if not products:\n            print(\"Error: No data found in CSV file\")\n            return False\n        \n        # Determine which column to use for product names\n        fieldnames = list(products[0].keys())\n        product_column = None\n        \n        # Look for common product name columns\n        for col in ['Product Name', 'Name', 'Product', 'Item', 'Title']:\n            if col in fieldnames:\n                product_column = col\n                break\n        \n        if not product_column:\n            print(\"Available columns:\", ', '.join(fieldnames))\n            product_column = input(\"Enter column name to use for labels: \").strip()\n            if product_column not in fieldnames:\n                print(f\"Error: Column '{product_column}' not found\")\n                return False\n        \n        # Filter products by range\n        if end:\n            products = products[start-1:end]\n        else:\n            products = products[start-1:]\n        \n        if test_mode:\n            products = products[:1]\n            print(f\"TEST MODE: Printing only first product\")\n        \n        print(f\"Printing {len(products)} labels from column '{product_column}'...\")\n        \n        success_count = 0\n        for i, row in enumerate(products, start):\n            product_name = row.get(product_column, '').strip()\n            if not product_name:\n                print(f\"Skipping empty row {i}\")\n                continue\n            \n            print(f\"[{i}/{start + len(products) - 1}] {product_name}\")\n            \n            if print_single_label(printer_id, product_name, label_type, include_qr):\n                success_count += 1\n                print(\"  ✓ Success\")\n            else:\n                print(\"  ✗ Failed\")\n                if not test_mode:\n                    response = input(\"Continue? (y/n): \").lower()\n                    if response != 'y':\n                        break\n        \n        print(f\"\\nCompleted: {success_count}/{len(products)} labels printed successfully\")\n        return success_count > 0\n    \n    except FileNotFoundError:\n        print(f\"Error: CSV file '{csv_file}' not found\")\n        return False\n    except Exception as e:\n        print(f\"Error processing CSV: {e}\")\n        return False\n\n\ndef main():\n    parser = argparse.ArgumentParser(\n        description='Print labels with QR codes on Brother QL-700',\n        formatter_class=argparse.RawDescriptionHelpFormatter,\n        epilog=\"\"\"\nExamples:\n  %(prog)s products.csv --test\n  %(prog)s products.csv --printer \"usb://0x04f9:0x2042\"\n  %(prog)s products.csv --start 1 --end 100\n  %(prog)s products.csv --no-qr\n        \"\"\"\n    )\n    \n    parser.add_argument('csv_file', help='Path to CSV file with product data')\n    parser.add_argument('--printer', help='Printer identifier (auto-detected if not specified)')\n    parser.add_argument('--label', default='62', choices=['29', '38', '62', '17x54', '29x90'],\n                       help='Label size (default: 62mm continuous)')\n    parser.add_argument('--test', action='store_true',\n                       help='Print only the first product as a test')\n    parser.add_argument('--no-qr', action='store_true',\n                       help='Print without QR codes')\n    parser.add_argument('--start', type=int, default=1,\n                       help='Start at row number (default: 1)')\n    parser.add_argument('--end', type=int,\n                       help='End at row number (optional)')\n    parser.add_argument('--discover', action='store_true',\n                       help='Discover available printers and exit')\n    \n    args = parser.parse_args()\n    \n    # Discover printers if requested\n    if args.discover:\n        print(\"Discovering Brother QL printers...\")\n        printers = print_utils.discover_printers()\n        if printers:\n            print(f\"Found {len(printers)} printer(s):\")\n            for printer in printers:\n                print(f\"  {printer['identifier']} - {printer['instance']}\")\n        else:\n            print(\"No Brother QL printers found\")\n            print(\"\\nTroubleshooting:\")\n            print(\"• Check USB connection\")\n            print(\"• Ensure printer is powered on\")\n            print(\"• Try different USB port\")\n            print(\"• On Linux, check USB permissions\")\n        return\n    \n    # Validate CSV file\n    if not os.path.exists(args.csv_file):\n        print(f\"Error: CSV file '{args.csv_file}' not found\")\n        sys.exit(1)\n    \n    # Auto-detect printer if not specified\n    printer_id = args.printer\n    if not printer_id:\n        print(\"Auto-detecting printer...\")\n        printers = print_utils.discover_printers()\n        if printers:\n            printer_id = printers[0]['identifier']\n            print(f\"Using printer: {printer_id}\")\n        else:\n            print(\"No printers found. Use --discover to troubleshoot.\")\n            sys.exit(1)\n    \n    # Start printing\n    include_qr = not args.no_qr\n    success = print_from_csv(\n        csv_file=args.csv_file,\n        printer_id=printer_id,\n        label_type=args.label,\n        include_qr=include_qr,\n        start=args.start,\n        end=args.end,\n        test_mode=args.test\n    )\n    \n    if not success:\n        sys.exit(1)\n\n\nif __name__ == '__main__':\n    main()