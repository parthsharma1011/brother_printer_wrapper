// Enhanced JavaScript for Brother QL-700 Label Printer Web Interface\n\nclass LabelPrinter {\n    constructor() {\n        this.currentCSV = null;\n        this.availableColumns = [];\n        this.selectedColumns = [];\n        this.isJobRunning = false;\n        this.statusInterval = null;\n        \n        this.initializeEventListeners();\n        this.updateUI();\n    }\n\n    initializeEventListeners() {\n        // File upload\n        document.getElementById('upload').addEventListener('click', () => this.uploadCSV());\n        document.getElementById('sample').addEventListener('click', () => this.useSampleData());\n        \n        // Settings\n        document.getElementById('genPreview').addEventListener('click', () => this.generatePreview());\n        \n        // Printer\n        document.getElementById('detect').addEventListener('click', () => this.detectPrinters());\n        document.getElementById('startPrint').addEventListener('click', () => this.startPrinting());\n        \n        // Logs\n        document.getElementById('clearLogs').addEventListener('click', () => this.clearLogs());\n        \n        // Auto-detect printers on load\n        setTimeout(() => this.detectPrinters(), 1000);\n    }\n\n    showToast(message, type = 'info') {\n        const toast = document.getElementById('toast');\n        const colors = {\n            success: '#48bb78',\n            error: '#f56565',\n            warning: '#ed8936',\n            info: '#4299e1'\n        };\n        \n        toast.style.background = colors[type] || colors.info;\n        toast.textContent = message;\n        toast.style.transform = 'translateX(0)';\n        \n        setTimeout(() => {\n            toast.style.transform = 'translateX(400px)';\n        }, 3000);\n    }\n\n    log(message, type = 'info') {\n        const logs = document.getElementById('logs');\n        const timestamp = new Date().toLocaleTimeString();\n        const indicator = {\n            success: '‚úÖ',\n            error: '‚ùå',\n            warning: '‚ö†Ô∏è',\n            info: '‚ÑπÔ∏è'\n        }[type] || '‚ÑπÔ∏è';\n        \n        logs.textContent += `[${timestamp}] ${indicator} ${message}\\n`;\n        logs.scrollTop = logs.scrollHeight;\n    }\n\n    clearLogs() {\n        document.getElementById('logs').textContent = 'Logs cleared...\\n';\n    }\n\n    updateUI() {\n        const hasCSV = this.currentCSV !== null;\n        const hasColumns = this.selectedColumns.length > 0;\n        \n        document.getElementById('genPreview').disabled = !hasCSV || !hasColumns;\n        document.getElementById('startPrint').disabled = !hasCSV || !hasColumns || this.isJobRunning;\n        \n        // Update button text based on job status\n        const printBtn = document.getElementById('startPrint');\n        if (this.isJobRunning) {\n            printBtn.textContent = '‚è∏Ô∏è Printing...';\n            printBtn.classList.add('loading');\n        } else {\n            printBtn.textContent = 'üöÄ Start Printing';\n            printBtn.classList.remove('loading');\n        }\n    }\n\n    async uploadCSV() {\n        const fileInput = document.getElementById('csvfile');\n        const file = fileInput.files[0];\n        \n        if (!file) {\n            this.showToast('Please select a CSV file first', 'warning');\n            return;\n        }\n        \n        if (!file.name.toLowerCase().endsWith('.csv')) {\n            this.showToast('Please select a valid CSV file', 'error');\n            return;\n        }\n        \n        const formData = new FormData();\n        formData.append('file', file);\n        \n        try {\n            this.log(`Uploading ${file.name}...`);\n            const response = await fetch('/upload-csv', {\n                method: 'POST',\n                body: formData\n            });\n            \n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw new Error(data.error || 'Upload failed');\n            }\n            \n            this.currentCSV = data.path;\n            this.availableColumns = data.columns;\n            this.renderColumnSelection();\n            this.log(`Successfully uploaded ${file.name} with ${data.columns.length} columns`, 'success');\n            this.showToast('CSV uploaded successfully!', 'success');\n            \n        } catch (error) {\n            this.log(`Upload error: ${error.message}`, 'error');\n            this.showToast(`Upload failed: ${error.message}`, 'error');\n        }\n        \n        this.updateUI();\n    }\n\n    async useSampleData() {\n        try {\n            this.log('Loading sample data...');\n            const response = await fetch('/use-sample');\n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw new Error(data.error || 'Failed to load sample');\n            }\n            \n            this.currentCSV = data.path;\n            this.availableColumns = data.columns;\n            this.renderColumnSelection();\n            this.log(`Loaded sample data with ${data.columns.length} columns`, 'success');\n            this.showToast('Sample data loaded!', 'success');\n            \n        } catch (error) {\n            this.log(`Sample data error: ${error.message}`, 'error');\n            this.showToast(`Failed to load sample: ${error.message}`, 'error');\n        }\n        \n        this.updateUI();\n    }\n\n    renderColumnSelection() {\n        const container = document.getElementById('columns');\n        container.innerHTML = '';\n        \n        if (this.availableColumns.length === 0) {\n            container.innerHTML = '<p style=\"color: #718096; font-style: italic;\">No columns available</p>';\n            return;\n        }\n        \n        this.availableColumns.forEach(column => {\n            const div = document.createElement('div');\n            div.className = 'column-item';\n            \n            const checkbox = document.createElement('input');\n            checkbox.type = 'checkbox';\n            checkbox.id = `col-${column}`;\n            checkbox.value = column;\n            checkbox.checked = this.selectedColumns.includes(column);\n            \n            checkbox.addEventListener('change', (e) => {\n                if (e.target.checked) {\n                    if (!this.selectedColumns.includes(column)) {\n                        this.selectedColumns.push(column);\n                    }\n                } else {\n                    this.selectedColumns = this.selectedColumns.filter(c => c !== column);\n                }\n                this.updateUI();\n            });\n            \n            const label = document.createElement('label');\n            label.htmlFor = `col-${column}`;\n            label.textContent = column;\n            label.style.cursor = 'pointer';\n            \n            div.appendChild(checkbox);\n            div.appendChild(label);\n            container.appendChild(div);\n        });\n        \n        // Auto-select first column if none selected\n        if (this.selectedColumns.length === 0 && this.availableColumns.length > 0) {\n            this.selectedColumns = [this.availableColumns[0]];\n            document.getElementById(`col-${this.availableColumns[0]}`).checked = true;\n        }\n    }\n\n    async generatePreview() {\n        if (!this.currentCSV || this.selectedColumns.length === 0) {\n            this.showToast('Please upload CSV and select columns first', 'warning');\n            return;\n        }\n        \n        try {\n            this.log('Generating preview...');\n            const response = await fetch('/preview', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    path: this.currentCSV,\n                    columns: this.selectedColumns,\n                    qr: document.getElementById('qr').checked\n                })\n            });\n            \n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw new Error(data.error || 'Preview generation failed');\n            }\n            \n            const previewImg = document.getElementById('previewImg');\n            previewImg.innerHTML = `<img src=\"data:image/png;base64,${data.image_base64}\" alt=\"Label preview\" style=\"max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);\">`;\n            \n            this.log('Preview generated successfully', 'success');\n            this.showToast('Preview ready!', 'success');\n            \n        } catch (error) {\n            this.log(`Preview error: ${error.message}`, 'error');\n            this.showToast(`Preview failed: ${error.message}`, 'error');\n        }\n    }\n\n    async detectPrinters() {\n        try {\n            this.log('Detecting printers...');\n            const response = await fetch('/printers');\n            const data = await response.json();\n            \n            const printersElement = document.getElementById('printers');\n            const printerIdInput = document.getElementById('printerId');\n            \n            if (data.printers && data.printers.length > 0) {\n                const printerList = data.printers.map(p => \n                    `üì± ${p.identifier || 'Unknown'} (${p.instance || 'USB Device'})`\n                ).join('\\n');\n                \n                printersElement.textContent = printerList;\n                \n                // Auto-fill first printer\n                if (data.printers[0].identifier) {\n                    printerIdInput.value = data.printers[0].identifier;\n                }\n                \n                this.log(`Found ${data.printers.length} printer(s)`, 'success');\n                this.showToast(`Found ${data.printers.length} printer(s)`, 'success');\n            } else {\n                printersElement.textContent = '‚ùå No Brother QL printers detected\\n\\nTroubleshooting:\\n‚Ä¢ Check USB connection\\n‚Ä¢ Ensure printer is powered on\\n‚Ä¢ Try different USB port';\n                this.log('No printers detected', 'warning');\n                this.showToast('No printers found', 'warning');\n            }\n            \n        } catch (error) {\n            document.getElementById('printers').textContent = `‚ùå Error detecting printers: ${error.message}`;\n            this.log(`Printer detection error: ${error.message}`, 'error');\n            this.showToast('Printer detection failed', 'error');\n        }\n    }\n\n    async startPrinting() {\n        if (!this.currentCSV || this.selectedColumns.length === 0) {\n            this.showToast('Please upload CSV and select columns first', 'warning');\n            return;\n        }\n        \n        const printerId = document.getElementById('printerId').value;\n        const start = parseInt(document.getElementById('start').value) || 1;\n        const end = document.getElementById('end').value ? parseInt(document.getElementById('end').value) : null;\n        const batchSize = parseInt(document.getElementById('batch').value) || 1;\n        const includeQR = document.getElementById('qr').checked;\n        \n        try {\n            this.log(`Starting print job (rows ${start}${end ? `-${end}` : '+'}...)`);\n            this.isJobRunning = true;\n            this.updateUI();\n            \n            const response = await fetch('/print', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    path: this.currentCSV,\n                    columns: this.selectedColumns,\n                    qr: includeQR,\n                    start: start,\n                    end: end,\n                    batch_size: batchSize,\n                    printer: printerId\n                })\n            });\n            \n            const data = await response.json();\n            \n            if (!response.ok) {\n                throw new Error(data.error || 'Print job failed to start');\n            }\n            \n            this.log(`Print job started: ${data.total} labels queued`, 'success');\n            this.showToast(`Printing ${data.total} labels...`, 'success');\n            \n            // Show progress area\n            document.getElementById('progressArea').style.display = 'block';\n            \n            // Start status polling\n            this.startStatusPolling();\n            \n        } catch (error) {\n            this.isJobRunning = false;\n            this.updateUI();\n            this.log(`Print job error: ${error.message}`, 'error');\n            this.showToast(`Print failed: ${error.message}`, 'error');\n        }\n    }\n\n    startStatusPolling() {\n        this.statusInterval = setInterval(async () => {\n            try {\n                const response = await fetch('/status');\n                const data = await response.json();\n                \n                if (data.job) {\n                    const { running, progress, total } = data.job;\n                    \n                    if (total > 0) {\n                        const percentage = Math.round((progress / total) * 100);\n                        document.getElementById('progressFill').style.width = `${percentage}%`;\n                        document.getElementById('progressText').textContent = \n                            `Progress: ${progress}/${total} labels (${percentage}%)`;\n                    }\n                    \n                    if (!running && this.isJobRunning) {\n                        // Job completed\n                        this.isJobRunning = false;\n                        this.updateUI();\n                        clearInterval(this.statusInterval);\n                        \n                        this.log('Print job completed!', 'success');\n                        this.showToast('Printing completed!', 'success');\n                        \n                        setTimeout(() => {\n                            document.getElementById('progressArea').style.display = 'none';\n                        }, 3000);\n                    }\n                }\n                \n                // Update logs with new entries\n                if (data.logs && data.logs.length > 0) {\n                    const logsElement = document.getElementById('logs');\n                    const currentLogs = logsElement.textContent;\n                    const newLogs = data.logs.join('\\n');\n                    \n                    if (newLogs !== currentLogs) {\n                        logsElement.textContent = newLogs;\n                        logsElement.scrollTop = logsElement.scrollHeight;\n                    }\n                }\n                \n            } catch (error) {\n                console.error('Status polling error:', error);\n            }\n        }, 1000);\n    }\n}\n\n// Initialize the application when DOM is loaded\ndocument.addEventListener('DOMContentLoaded', () => {\n    new LabelPrinter();\n});