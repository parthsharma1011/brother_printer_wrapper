#!/usr/bin/env python3\n\"\"\"\nPrint utilities for Brother QL-700 Label Printer\nHandles label generation, QR codes, and printer communication\n\"\"\"\n\nimport qrcode\nfrom PIL import Image, ImageDraw, ImageFont\nfrom brother_ql.conversion import convert\nfrom brother_ql.backends.helpers import send, discover\nfrom brother_ql.raster import BrotherQLRaster\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n# Label specifications for Brother QL-700\nLABEL_SPECS = {\n    '62': {'width': 696, 'height': 271, 'name': '62mm Continuous'},\n    '29': {'width': 306, 'height': 271, 'name': '29mm Continuous'},\n    '38': {'width': 413, 'height': 271, 'name': '38mm Continuous'},\n    '17x54': {'width': 165, 'height': 566, 'name': '17x54mm Die-cut'},\n    '29x90': {'width': 306, 'height': 991, 'name': '29x90mm Die-cut'}\n}\n\n# Font paths for different operating systems\nFONT_PATHS = [\n    '/System/Library/Fonts/Helvetica.ttc',  # macOS\n    '/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf',  # Linux\n    'C:\\\\Windows\\\\Fonts\\\\arialbd.ttf',  # Windows\n    '/usr/share/fonts/TTF/DejaVuSans-Bold.ttf',  # Arch Linux\n]\n\n\ndef get_font(size=24, bold=True):\n    \"\"\"Get the best available font for the system\"\"\"\n    for font_path in FONT_PATHS:\n        try:\n            if font_path.endswith('.ttc') and bold:\n                # For .ttc files, try to get bold variant\n                return ImageFont.truetype(font_path, size, index=1)\n            else:\n                return ImageFont.truetype(font_path, size)\n        except (OSError, IOError):\n            continue\n    \n    # Fallback to default font\n    logger.warning(\"No system fonts found, using default font\")\n    return ImageFont.load_default()\n\n\ndef create_qr_code(text, size=150):\n    \"\"\"Create a QR code image\"\"\"\n    qr = qrcode.QRCode(\n        version=1,\n        error_correction=qrcode.constants.ERROR_CORRECT_L,\n        box_size=3,\n        border=2,\n    )\n    qr.add_data(text)\n    qr.make(fit=True)\n    \n    qr_img = qr.make_image(fill_color=\"black\", back_color=\"white\")\n    return qr_img.resize((size, size), Image.Resampling.LANCZOS)\n\n\ndef wrap_text(text, font, max_width, draw):\n    \"\"\"Wrap text to fit within specified width\"\"\"\n    words = text.split()\n    lines = []\n    current_line = []\n    \n    for word in words:\n        test_line = ' '.join(current_line + [word])\n        bbox = draw.textbbox((0, 0), test_line, font=font)\n        text_width = bbox[2] - bbox[0]\n        \n        if text_width <= max_width:\n            current_line.append(word)\n        else:\n            if current_line:\n                lines.append(' '.join(current_line))\n                current_line = [word]\n            else:\n                # Single word is too long, add it anyway\n                lines.append(word)\n    \n    if current_line:\n        lines.append(' '.join(current_line))\n    \n    return lines\n\n\ndef create_label_image(text, label_type='62', include_qr=True, qr_size=156):\n    \"\"\"Create a label image with text and optional QR code\"\"\"\n    try:\n        # Get label specifications\n        if label_type not in LABEL_SPECS:\n            label_type = '62'  # Default fallback\n        \n        spec = LABEL_SPECS[label_type]\n        width, height = spec['width'], spec['height']\n        \n        # Create white background\n        img = Image.new('RGB', (width, height), 'white')\n        draw = ImageDraw.Draw(img)\n        \n        # Calculate layout\n        margin = 10\n        qr_actual_size = min(qr_size, height - 2 * margin) if include_qr else 0\n        \n        # Position QR code on the right\n        if include_qr and qr_actual_size > 0:\n            qr_img = create_qr_code(text, qr_actual_size)\n            qr_x = width - qr_actual_size - margin\n            qr_y = (height - qr_actual_size) // 2\n            img.paste(qr_img, (qr_x, qr_y))\n            text_max_width = qr_x - 2 * margin\n        else:\n            text_max_width = width - 2 * margin\n        \n        # Find optimal font size\n        max_font_size = min(48, height // 4)\n        min_font_size = 12\n        best_font = None\n        best_lines = []\n        \n        for font_size in range(max_font_size, min_font_size - 1, -2):\n            font = get_font(font_size, bold=True)\n            lines = wrap_text(text, font, text_max_width, draw)\n            \n            # Calculate total text height\n            line_height = font_size + 4\n            total_height = len(lines) * line_height\n            \n            if total_height <= height - 2 * margin:\n                best_font = font\n                best_lines = lines\n                break\n        \n        # Fallback if no size fits\n        if not best_font:\n            best_font = get_font(min_font_size, bold=True)\n            best_lines = wrap_text(text, best_font, text_max_width, draw)\n        \n        # Draw text\n        if best_lines:\n            line_height = best_font.size + 4 if hasattr(best_font, 'size') else 16\n            total_text_height = len(best_lines) * line_height\n            start_y = (height - total_text_height) // 2\n            \n            for i, line in enumerate(best_lines[:4]):  # Limit to 4 lines\n                y = start_y + i * line_height\n                draw.text((margin, y), line, fill='black', font=best_font)\n        \n        return img\n    \n    except Exception as e:\n        logger.error(f\"Error creating label image: {e}\")\n        # Return a simple error image\n        img = Image.new('RGB', (696, 271), 'white')\n        draw = ImageDraw.Draw(img)\n        font = get_font(24)\n        draw.text((10, 100), f\"Error: {str(e)[:50]}\", fill='red', font=font)\n        return img\n\n\ndef create_label_image_preview(text, qr_enabled=True):\n    \"\"\"Create a preview image (same as regular but for web interface)\"\"\"\n    return create_label_image(text, include_qr=qr_enabled)\n\n\ndef discover_printers():\n    \"\"\"Discover available Brother QL printers\"\"\"\n    try:\n        devices = discover('pyusb')\n        printers = []\n        \n        for device in devices:\n            # Clean up the identifier to remove special characters\n            identifier = device.get('identifier', '')\n            if identifier:\n                # Remove any non-ASCII characters that might cause issues\n                clean_id = ''.join(char for char in identifier if ord(char) < 128)\n                # Further clean to standard format\n                if 'usb://' in clean_id and ':' in clean_id:\n                    parts = clean_id.split('_')[0]  # Remove anything after underscore\n                    printers.append({\n                        'identifier': parts,\n                        'instance': str(device.get('instance', 'USB Device'))\n                    })\n        \n        return printers\n    \n    except Exception as e:\n        logger.error(f\"Error discovering printers: {e}\")\n        return []\n\n\ndef print_label_safe(printer_id=None, label_text=\"\", label_type='62', include_qr=True):\n    \"\"\"Safely print a label with error handling\"\"\"\n    try:\n        # Use default printer if none specified\n        if not printer_id:\n            printers = discover_printers()\n            if not printers:\n                raise Exception(\"No printers found\")\n            printer_id = printers[0]['identifier']\n        \n        # Create label image\n        img = create_label_image(label_text, label_type, include_qr)\n        \n        # Convert to Brother QL format\n        qlr = BrotherQLRaster('QL-700')\n        instructions = convert(\n            qlr=qlr,\n            images=[img],\n            label=label_type,\n            rotate='0',  # No rotation for horizontal labels\n            threshold=70.0,\n            dither=False,\n            compress=False,\n            red=False,\n            dpi_600=False,\n            hq=True,\n            cut=True\n        )\n        \n        # Send to printer\n        send(\n            instructions=instructions,\n            printer_identifier=printer_id,\n            backend_identifier='pyusb',\n            blocking=True\n        )\n        \n        logger.info(f\"Successfully printed label: {label_text[:50]}...\")\n        \n    except Exception as e:\n        logger.error(f\"Print error: {e}\")\n        raise Exception(f\"Failed to print label: {str(e)}\")\n\n\ndef print_label_for_ui(printer_id, label_text, label_type='62', qr_enabled=True):\n    \"\"\"Print label function specifically for web UI\"\"\"\n    return print_label_safe(\n        printer_id=printer_id,\n        label_text=label_text,\n        label_type=label_type,\n        include_qr=qr_enabled\n    )\n\n\ndef list_printers():\n    \"\"\"List available printers (alias for discover_printers)\"\"\"\n    return discover_printers()\n\n\nif __name__ == '__main__':\n    # Test the module\n    print(\"Testing Brother QL-700 Print Utilities...\")\n    \n    # Test printer discovery\n    printers = discover_printers()\n    print(f\"Found {len(printers)} printer(s)\")\n    for printer in printers:\n        print(f\"  - {printer['identifier']}\")\n    \n    # Test image creation\n    test_img = create_label_image(\"TEST LABEL - Brother QL-700\", include_qr=True)\n    print(f\"Created test image: {test_img.size}\")\n    \n    print(\"Module test completed.\")